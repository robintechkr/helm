# Valkey Standalone Configuration
# Single instance with AOF persistence

# Replica disabled for standalone mode
replica:
  enabled: false

# Authentication (ACL)
auth:
  enabled: true
  # 비밀번호가 저장된 기존 Secret 이름
  usersExistingSecret: "valkey-auth"
  # ACL 사용자 정의
  aclUsers:
    # default 사용자 (필수 - 없으면 누구나 접근 가능)
    default:
      # 모든 키, 모든 채널, 모든 명령 허용
      permissions: "~* &* +@all"
      # Secret에서 비밀번호를 가져올 키 이름 (기본값: 사용자 이름)
      passwordKey: "password"

# Persistent storage for AOF and RDB
dataStorage:
  enabled: true
  requestedSize: "10Gi"
  # StorageClass name (empty = use cluster default)
  # Examples: "standard", "gp2", "local-path", etc.
  className: "local-path"
  accessModes:
    - ReadWriteOnce
  # Keep PVC on helm uninstall (prevent data loss)
  keepPvc: true

# Resource limits matching maxmemory (3GB Pod)
resources:
  requests:
    memory: "2.5Gi"
    cpu: "800m"
  limits:
    memory: "3Gi"
    cpu: "1000m"

# Valkey configuration
valkeyConfig: |
  # Memory (Pod: 3GB / Valkey: 2GB / CoW Buffer: 1GB)
  maxmemory 2gb
  # TTL 설정된 키만 삭제 (이벤트 데이터 보존)
  maxmemory-policy volatile-lru
  
  # RDB Snapshot (SATA SSD 부하 저감)
  # 1시간마다 (변경 1개 이상)
  save 3600 1
  # 5분마다 (변경 100개 이상)
  save 300 100
  stop-writes-on-bgsave-error yes
  rdbcompression yes
  rdbchecksum yes
  rdb-save-incremental-fsync yes
  
  # AOF (Event Sourcing)
  appendonly yes
  # 최대 1초 데이터 유실 허용
  appendfsync everysec
  # 빠른 복구를 위한 하이브리드 포맷
  aof-use-rdb-preamble yes
  # Rewrite 중 디스크 동기화 중단 (SATA 멈춤 방지)
  no-appendfsync-on-rewrite yes  
  auto-aof-rewrite-percentage 100
  # 파일 1GB 도달 전에는 Rewrite 안 함 (I/O 빈도 감소)
  auto-aof-rewrite-min-size 1gb
  aof-rewrite-incremental-fsync yes
  
  # Performance
  io-threads 1
  lazyfree-lazy-eviction yes
  lazyfree-lazy-expire yes
  # 백그라운드 삭제 (메인 스레드 멈춤 방지)
  lazyfree-lazy-user-del yes
  
  # Network & Logging
  tcp-backlog 511
  tcp-keepalive 300
  loglevel notice
